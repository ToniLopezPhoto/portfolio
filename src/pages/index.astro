---
import { getCollection } from "astro:content";
import Container from "@components/Container.astro";
import PageLayout from "@layouts/PageLayout.astro";
import ArrowCard from "@components/ArrowCard.astro";
import Link from "@components/Link.astro";
import { dateRange } from "@lib/utils";
import { SITE, HOME, SOCIALS } from "@consts";

// --- IMÁGENES ---
import { Image } from "astro:assets";
// Importamos las fotos para el tendedero y el fallback
import foto1 from "../assets/foto1.jpg";
import foto2 from "../assets/foto2.jpg";
import foto3 from "../assets/foto3.jpg";
import foto4 from "../assets/foto4.jpg"; 
import foto5 from "../assets/foto5.jpg";
import foto6 from "../assets/foto6.jpg";
import foto7 from "../assets/foto7.jpg";
import foto8 from "../assets/foto8.jpg";

// --- CONFIGURACIÓN DE LA GALERÍA TENDEDERO ---
const datosGaleriaIniciales = [
  { img: foto1, titulo: "Estudio de la forma nº1" },
  { img: foto2, titulo: "Vínculos rotos" },
  { img: foto3, titulo: "La espera en la jungla" },
  { img: foto5, titulo: "Retrato del tiempo" },
  { img: foto6, titulo: "La calidez del sonido" },
  { img: foto7, titulo: "El taller del alquimista" },
  { img: foto8, titulo: "Diálogo nocturno" }
];

// Desordenamos aleatoriamente
const galeriaTendedero = [...datosGaleriaIniciales].sort(() => Math.random() - 0.5);

function getRotacionAleatoria() {
  const angulos = [
    "rotate-1", "-rotate-1",
    "rotate-2", "-rotate-2",
    "rotate-3", "-rotate-3"
  ];
  return angulos[Math.floor(Math.random() * angulos.length)];
}

// --- DATOS ---

// 1. BLOG
const blog = (await getCollection("blog"))
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0,SITE.NUM_POSTS_ON_HOMEPAGE);

// 2. PROYECTOS (LISTADO INFERIOR)
const projects = (await getCollection("projects"))
  .filter(project => !project.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0,SITE.NUM_PROJECTS_ON_HOMEPAGE);

// 3. PROYECTOS PARA LA GALERÍA MASONRY (SELECTED WORKS)
const masonryProjects = (await getCollection("projects"))
  .filter(project => !project.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 6); 

// 4. WORK (Oculto pero cargado)
const allwork = (await getCollection("work"))
  .sort((a, b) => new Date(b.data.dateStart).valueOf() - new Date(a.data.dateStart).valueOf())
  .slice(0,SITE.NUM_WORKS_ON_HOMEPAGE);

const work = await Promise.all(
  allwork.map(async (item) => {
    const { Content } = await item.render();
    return { ...item, Content };
  })
);
---

<PageLayout title={HOME.TITLE} description={HOME.DESCRIPTION}>
  
  <Container>
    <div class="space-y-12">
      <section>
        <article class="mt-2 space-y-6">
          <p class="animate text-3xl font-serif leading-relaxed text-white font-medium">
            Artista visual, fotógrafo e investigador sobre los 
            <span class="bg-white text-black px-2 py-0.5 rounded-sm">
              vínculos emocionales
            </span>, 
            la norma humana y esa experiencia que nos hace formar parte de una 
            <span class="bg-white text-black px-2 py-0.5 rounded-sm">
              jungla cívica
            </span>, 
            llamada sociedad.
          </p>

          <div class="animate">
            <a href={`mailto:${SITE.EMAIL}`} 
               class="group flex w-fit items-center gap-2 text-white/70 hover:text-white transition-colors duration-300">
              <span class="text-lg">Contactar</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-300 group-hover:translate-x-1">
                <line x1="5" y1="12" x2="19" y2="12"></line>
                <polyline points="12 5 19 12 12 19"></polyline>
              </svg>
            </a>
          </div>
        </article>
      </section>
    </div>
  </Container>

  <div class="w-full overflow-hidden py-24 bg-neutral-950/30 my-8 relative group-slider">
      
      <div class="absolute top-[22%] left-0 w-full z-0 pointer-events-none opacity-60">
        <svg width="100%" height="40" viewBox="0 0 1200 40" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">
           <path d="M0 20 C 300 25, 600 15, 900 20 C 1000 22, 1100 18, 1200 20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" class="text-white/40" vector-effect="non-scaling-stroke"/>
        </svg>
      </div>

      <div id="slider-tendedero" class="relative z-10 overflow-x-auto flex items-center scrollbar-hide cursor-grab active:cursor-grabbing px-8 md:px-[15vw] select-none">
          <div class="relative flex flex-nowrap items-start gap-12 min-w-max py-10 pointer-events-none">
              {galeriaTendedero.map((item) => {
                const rotacion = getRotacionAleatoria();
                return (
                <div class={`group relative bg-neutral-950 p-3 pb-5 rounded-sm shadow-lg border border-white/10 transition-transform duration-500 ease-out hover:scale-105 hover:rotate-0 ${rotacion} w-[280px] shrink-0 pointer-events-auto`}>
                   <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-4 h-6 bg-neutral-800 border border-white/20 rounded-sm z-20 shadow-sm"></div>
                   <div class="aspect-[4/3] overflow-hidden relative border border-white/5 bg-neutral-900">
                      <Image 
                        src={item.img}
                        alt={`Hoja de contacto: ${item.titulo}`}
                        class="object-cover w-full h-full grayscale group-hover:grayscale-0 transition-all duration-700 ease-out opacity-90 group-hover:opacity-100 pointer-events-none"
                        width={400} 
                        format="webp"
                      />
                   </div>
                   <p class="font-handwriting text-left text-white/70 mt-4 text-base tracking-wide transition-colors group-hover:text-white">
                       {item.titulo}
                   </p>
                </div>
              )})}
              <div class="w-16 shrink-0"></div>
          </div>
      </div>
  </div>

  <Container>
    <div class="space-y-24 pb-24">

      <section class="animate grid grid-cols-1 md:grid-cols-2 gap-12 items-start">
        <div class="space-y-6">
          <h5 class="font-serif text-3xl text-white font-medium leading-tight">
            El deseo de cambiar algo, sin encontrarlo. 
            <span class="bg-white text-black px-2 py-0.5 rounded-sm decoration-clone">
            El deseo de ser, sin ser.
            </span>
          </h5>
          <p class="text-gray-300 leading-relaxed">
            Cada imagen es un fragmento de una conversación silenciosa. En mi proceso creativo, busco deconstruir lo cotidiano para encontrar la poesía oculta en las estructuras urbanas y humanas.
          </p>
        </div>
        <div class="aspect-square overflow-hidden rounded-sm bg-neutral-900 relative group border border-white/10">
           <Image 
             src={foto4} 
             alt="Sobre mí"
             class="object-cover w-full h-full grayscale group-hover:grayscale-0 transition-all duration-700 ease-out group-hover:scale-105"
             width={600} 
             format="webp"
           />
        </div>
      </section>

      <div class="animate border-t border-white/20"></div>

      <section class="animate space-y-8">
        <div class="flex items-end justify-between">
            <h5 class="font-serif text-2xl text-white font-medium">Selected Works</h5>
            <span class="text-sm text-white/40 font-mono hidden md:block">FEATURED</span>
        </div>

        <div class="columns-1 md:columns-2 gap-4 space-y-4">
            {masonryProjects.map((project) => (
                <a href={`/projects/${project.slug}`} class="break-inside-avoid relative group overflow-hidden rounded-sm block bg-neutral-900 border border-white/5">
                    
                    <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-all duration-500 z-20 flex flex-col items-center justify-center p-4 text-center">
                        <span class="text-white font-serif text-2xl italic border-b border-white/50 pb-2 mb-2 translate-y-4 group-hover:translate-y-0 transition-transform duration-500">
                            {project.data.title}
                        </span>
                        <span class="text-white/60 text-sm font-sans uppercase tracking-widest translate-y-4 group-hover:translate-y-0 transition-transform duration-700 delay-75">
                            Ver Proyecto
                        </span>
                    </div>

                    <Image 
                        src={project.data.heroImage || foto1} 
                        alt={project.data.title}
                        class="w-full h-auto object-cover grayscale group-hover:grayscale-0 transition-all duration-1000 ease-in-out group-hover:scale-105"
                        width={1000} 
                        format="webp"
                    />
                </a>
            ))}
        </div>
      </section>

      <div class="animate border-t border-white/20"></div>

      <section class="animate space-y-6">
        <div class="flex flex-wrap gap-y-2 items-center justify-between">
          <h5 class="font-semibold text-white">Recent projects</h5>
          <Link href="/projects">See all projects</Link>
        </div>
        <ul class="flex flex-col gap-4">
          {projects.map(project => (
            <li>
              <ArrowCard entry={project} />
            </li>
          ))}
        </ul>
      </section>

      <section class="animate space-y-6">
        <div class="flex flex-wrap gap-y-2 items-center justify-between">
          <h5 class="font-semibold text-white">Latest posts</h5>
          <Link href="/blog">See all posts</Link>
        </div>
        <ul class="flex flex-col gap-4">
          {blog.map(post => (
            <li>
              <ArrowCard entry={post} />
            </li>
          ))}
        </ul>
      </section>

      <section class="animate space-y-4">
        <h5 class="font-semibold text-white">Let's Connect</h5>
        <article>
          <p class="text-gray-300">
            If you want to get in touch with me about something or just to say hi,
            reach out on social media or send me an email.
          </p>
        </article>
        <ul class="flex flex-wrap gap-2">
          {SOCIALS.map(SOCIAL => (
            <li class="flex gap-x-2 text-nowrap">
              <Link href={SOCIAL.HREF} external aria-label={`${SITE.NAME} on ${SOCIAL.NAME}`}>
                {SOCIAL.NAME}
              </Link>
              {"/"}
            </li>
          ))}
          <li class="line-clamp-1">
            <Link href={`mailto:${SITE.EMAIL}`} aria-label={`Email ${SITE.NAME}`}>
              {SITE.EMAIL}
            </Link>
          </li>
        </ul>
      </section>
    </div>
  </Container>

  <style>
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  </style>

  <script is:inline>
    const slider = document.getElementById('slider-tendedero');
    let isDown = false;
    let startX;
    let scrollLeft;

    slider.addEventListener('mousedown', (e) => {
      isDown = true;
      slider.classList.add('active'); 
      startX = e.pageX - slider.offsetLeft;
      scrollLeft = slider.scrollLeft;
    });

    slider.addEventListener('mouseleave', () => {
      isDown = false;
      slider.classList.remove('active');
    });

    slider.addEventListener('mouseup', () => {
      isDown = false;
      slider.classList.remove('active');
    });

    slider.addEventListener('mousemove', (e) => {
      if(!isDown) return;
      e.preventDefault();
      const x = e.pageX - slider.offsetLeft;
      const walk = (x - startX) * 2;
      slider.scrollLeft = scrollLeft - walk;
    });
  </script>

</PageLayout>